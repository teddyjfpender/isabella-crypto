#!/usr/bin/env bash
#
# scaffold.sh - Create/initialize an Isabelle HOL project structure
#
# Creates the necessary files and directories for an Isabelle session:
#   - ROOT file with session configuration
#   - Basic theory file template
#   - document/ directory for LaTeX output
#
# Usage:
#   ./scaffold.sh --work-dir <dir> [options]
#
# Options:
#   --work-dir <dir>      Working directory for the project (required)
#   --session <name>      Session name (default: CryptoProofs)
#   --theory <name>       Main theory file name (default: same as session)
#   --parent <session>    Parent session (default: HOL)
#   --template <file>     Template theory file to use
#   --no-document         Skip document directory setup
#   --force               Overwrite existing files
#   --verbose             Enable verbose output
#
set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Default values
WORK_DIR=""
SESSION_NAME="CryptoProofs"
THEORY_NAME=""
PARENT_SESSION="HOL"
TEMPLATE_FILE=""
NO_DOCUMENT=false
FORCE=false
VERBOSE=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

log_verbose() {
    if [[ "$VERBOSE" == "true" ]]; then
        echo -e "${BLUE}[DEBUG]${NC} $1"
    fi
}

usage() {
    cat <<EOF
Usage: $(basename "$0") --work-dir <dir> [options]

Options:
  --work-dir <dir>      Working directory for the project (required)
  --session <name>      Session name (default: CryptoProofs)
  --theory <name>       Main theory file name (default: same as session)
  --parent <session>    Parent session (default: HOL)
  --template <file>     Template theory file to use
  --no-document         Skip document directory setup
  --force               Overwrite existing files
  --verbose             Enable verbose output
  -h, --help            Show this help message

Example:
  $(basename "$0") --work-dir ./work/lattice --session LatticeCrypto
  $(basename "$0") --work-dir ./work/ring --session RingSignatures --parent HOL-Algebra
EOF
    exit 1
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --work-dir)
            WORK_DIR="$2"
            shift 2
            ;;
        --session)
            SESSION_NAME="$2"
            shift 2
            ;;
        --theory)
            THEORY_NAME="$2"
            shift 2
            ;;
        --parent)
            PARENT_SESSION="$2"
            shift 2
            ;;
        --template)
            TEMPLATE_FILE="$2"
            shift 2
            ;;
        --no-document)
            NO_DOCUMENT=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            ;;
    esac
done

# Validate required arguments
if [[ -z "$WORK_DIR" ]]; then
    log_error "Missing required argument: --work-dir"
    usage
fi

# Default theory name to session name
if [[ -z "$THEORY_NAME" ]]; then
    THEORY_NAME="$SESSION_NAME"
fi

log_info "Scaffolding Isabelle project: ${SESSION_NAME}"
log_verbose "Work directory: ${WORK_DIR}"
log_verbose "Session name: ${SESSION_NAME}"
log_verbose "Theory name: ${THEORY_NAME}"
log_verbose "Parent session: ${PARENT_SESSION}"

# Create work directory
mkdir -p "$WORK_DIR"

# Create ROOT file
ROOT_FILE="${WORK_DIR}/ROOT"
if [[ -f "$ROOT_FILE" ]] && [[ "$FORCE" == "false" ]]; then
    log_warn "ROOT file already exists, skipping (use --force to overwrite)"
else
    log_info "Creating ROOT file..."
    cat > "$ROOT_FILE" <<EOF
(* Isabelle session configuration *)
(* Generated by scaffold.sh *)

session "${SESSION_NAME}" = "${PARENT_SESSION}" +
  description "
    Cryptographic proofs and formal verification.
    Generated for evaluation purposes.
  "
  options [
    document = pdf,
    document_output = "output/document",
    browser_info
  ]
  sessions
    "HOL-Library"
    "HOL-Number_Theory"
  theories
    ${THEORY_NAME}
  document_files
    "root.tex"
EOF
    log_success "Created ROOT file: ${ROOT_FILE}"
fi

# Create main theory file
THEORY_FILE="${WORK_DIR}/${THEORY_NAME}.thy"
if [[ -f "$THEORY_FILE" ]] && [[ "$FORCE" == "false" ]]; then
    log_warn "Theory file already exists, skipping (use --force to overwrite)"
elif [[ -n "$TEMPLATE_FILE" ]] && [[ -f "$TEMPLATE_FILE" ]]; then
    log_info "Creating theory file from template..."
    cp "$TEMPLATE_FILE" "$THEORY_FILE"
    log_success "Created theory file from template: ${THEORY_FILE}"
else
    log_info "Creating theory file template..."
    cat > "$THEORY_FILE" <<'EOF'
theory ${THEORY_NAME}
  imports
    Main
    "HOL-Library.Code_Target_Int"
    "HOL-Number_Theory.Number_Theory"
begin

section \<open>Overview\<close>

text \<open>
  This theory contains formal proofs for cryptographic constructions.

  Key definitions and lemmas:
  \<^item> Basic algebraic structures
  \<^item> Security definitions
  \<^item> Correctness proofs
\<close>

section \<open>Preliminaries\<close>

subsection \<open>Basic Definitions\<close>

text \<open>Define basic types and operations here.\<close>

(* TODO: Add definitions *)

subsection \<open>Helper Lemmas\<close>

text \<open>Auxiliary lemmas for main proofs.\<close>

(* TODO: Add helper lemmas *)

section \<open>Main Results\<close>

text \<open>Main theorems and proofs.\<close>

(* TODO: Add main theorems *)

section \<open>Code Generation\<close>

text \<open>Export executable code to Haskell.\<close>

(* TODO: Add code equations and export *)

(*
export_code
  in Haskell
  module_name ${THEORY_NAME}_Code
  file_prefix ${THEORY_NAME}
*)

end
EOF
    # Replace placeholder with actual theory name
    sed -i.bak "s/\${THEORY_NAME}/${THEORY_NAME}/g" "$THEORY_FILE" && rm -f "${THEORY_FILE}.bak"
    log_success "Created theory file: ${THEORY_FILE}"
fi

# Create document directory
if [[ "$NO_DOCUMENT" == "false" ]]; then
    DOC_DIR="${WORK_DIR}/document"
    mkdir -p "$DOC_DIR"

    ROOT_TEX="${DOC_DIR}/root.tex"
    if [[ -f "$ROOT_TEX" ]] && [[ "$FORCE" == "false" ]]; then
        log_warn "root.tex already exists, skipping (use --force to overwrite)"
    else
        log_info "Creating document/root.tex..."
        cat > "$ROOT_TEX" <<EOF
\\documentclass[11pt,a4paper]{article}
\\usepackage{isabelle,isabellesym}
\\usepackage{amsmath,amssymb}
\\usepackage{hyperref}

% URLs
\\usepackage{url}
\\urlstyle{rm}

% Document info
\\title{${SESSION_NAME}}
\\author{Generated}

\\begin{document}

\\maketitle

\\tableofcontents

\\newpage

% Include generated theory documentation
\\input{session}

\\bibliographystyle{abbrv}
\\bibliography{root}

\\end{document}
EOF
        log_success "Created document/root.tex: ${ROOT_TEX}"
    fi

    # Create empty bib file
    BIB_FILE="${DOC_DIR}/root.bib"
    if [[ ! -f "$BIB_FILE" ]]; then
        touch "$BIB_FILE"
        log_verbose "Created empty root.bib"
    fi
fi

# Create output directories
mkdir -p "${WORK_DIR}/output"
log_verbose "Created output directory"

# Run ensure_root_file.py if it exists
ENSURE_ROOT_SCRIPT="${SCRIPT_DIR}/ensure_root_file.py"
if [[ -f "$ENSURE_ROOT_SCRIPT" ]]; then
    log_info "Running ensure_root_file.py to normalize configuration..."
    python3 "$ENSURE_ROOT_SCRIPT" "$ROOT_FILE" || log_warn "ensure_root_file.py failed"
else
    log_verbose "ensure_root_file.py not found, skipping normalization"
fi

# Create .gitignore
GITIGNORE="${WORK_DIR}/.gitignore"
if [[ ! -f "$GITIGNORE" ]]; then
    cat > "$GITIGNORE" <<EOF
# Isabelle generated files
output/
.session/
*.log
*~

# Heap images
*.heap

# Browser info
browser_info/
EOF
    log_verbose "Created .gitignore"
fi

# Summary
log_info "========================================="
log_success "Isabelle project scaffolded successfully"
log_info "========================================="
log_info "Directory: ${WORK_DIR}"
log_info "Session: ${SESSION_NAME}"
log_info "Theory: ${THEORY_NAME}.thy"
log_info ""
log_info "Next steps:"
log_info "  1. Edit ${THEORY_NAME}.thy with your proofs"
log_info "  2. Run: isabelle build -d ${WORK_DIR} ${SESSION_NAME}"
log_info "========================================="

exit 0
