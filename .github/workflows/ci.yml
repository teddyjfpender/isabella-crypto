name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check if Canon files changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      canon: ${{ steps.filter.outputs.canon }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Canon changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            canon:
              - 'Canon/**'

  # Build and verify Isabelle theories (Canon)
  isabelle:
    name: Isabelle Canon
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.canon == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Cache Isabelle installation separately (rarely changes)
      - name: Cache Isabelle installation
        uses: actions/cache@v5
        id: cache-isabelle
        with:
          path: ~/Isabelle2025
          key: isabelle-2025-install-${{ runner.os }}

      # Cache heap images including HOL sessions (the slow part)
      - name: Cache Isabelle heaps
        uses: actions/cache@v5
        id: cache-heaps
        with:
          path: ~/.isabelle
          key: isabelle-2025-heaps-${{ runner.os }}-${{ hashFiles('Canon/ROOT', 'Canon/**/*.thy') }}
          restore-keys: |
            isabelle-2025-heaps-${{ runner.os }}-

      - name: Install Isabelle
        if: steps.cache-isabelle.outputs.cache-hit != 'true'
        run: |
          curl -L -o isabelle.tar.gz https://isabelle.in.tum.de/website-Isabelle2025/dist/Isabelle2025_linux.tar.gz
          tar -xzf isabelle.tar.gz -C ~
          rm isabelle.tar.gz

      - name: Add Isabelle to PATH
        run: echo "$HOME/Isabelle2025/bin" >> $GITHUB_PATH

      # Try to download pre-built HOL heaps from latest release (if available)
      - name: Download pre-built heaps
        if: steps.cache-heaps.outputs.cache-hit != 'true'
        continue-on-error: true
        run: |
          mkdir -p ~/.isabelle/Isabelle2025/heaps/polyml-5.9.1_x86_64_32-linux
          # Try to download from latest release
          if gh release download isabelle-heaps -p "heaps-linux.tar.gz" -O heaps.tar.gz 2>/dev/null; then
            tar -xzf heaps.tar.gz -C ~/.isabelle/Isabelle2025/heaps/
            rm heaps.tar.gz
            echo "Downloaded pre-built heaps from release"
          else
            echo "No pre-built heaps available, will build from scratch"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      # Build HOL sessions first if not cached (these take ~30 min)
      - name: Build HOL dependencies
        if: steps.cache-heaps.outputs.cache-hit != 'true'
        run: |
          echo "Building HOL sessions (this may take ~30 minutes on first run)..."
          isabelle build -v -b HOL-Library HOL-Number_Theory
        timeout-minutes: 45

      - name: Build Canon theories
        run: |
          cd Canon
          isabelle build -v -D .

      - name: Export code
        run: |
          cd Canon
          isabelle build -e -D .
        continue-on-error: true

      # Upload heap images as artifact for potential reuse
      - name: Upload heap images
        uses: actions/upload-artifact@v4
        with:
          name: isabelle-heaps
          path: ~/.isabelle/Isabelle2025/heaps/
          retention-days: 30

  # Build Haskell library
  haskell:
    name: Haskell Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.8'
          cabal-version: '3.10'

      - name: Cache Cabal
        uses: actions/cache@v5
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            isabella.hs/dist-newstyle
          key: cabal-${{ runner.os }}-ghc9.8-${{ hashFiles('isabella.hs/isabella.cabal') }}
          restore-keys: |
            cabal-${{ runner.os }}-ghc9.8-

      - name: Build Haskell
        working-directory: isabella.hs
        run: |
          cabal update
          cabal build all

      - name: Run Haskell tests
        working-directory: isabella.hs
        run: cabal test all
        continue-on-error: true

      - name: Run CLI examples
        working-directory: isabella.hs
        run: cabal run isabella-cli -- examples

  # Build OCaml library
  ocaml:
    name: OCaml Library
    runs-on: ubuntu-latest
    outputs:
      cli-available: ${{ steps.build.outputs.cli-available }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.2'

      - name: Cache opam
        uses: actions/cache@v5
        with:
          path: |
            ~/.opam
            isabella.ml/_build
          key: opam-${{ runner.os }}-ocaml5.2-${{ hashFiles('isabella.ml/dune-project', 'isabella.ml/dune') }}
          restore-keys: |
            opam-${{ runner.os }}-ocaml5.2-

      - name: Install OCaml dependencies
        run: |
          opam install -y dune zarith zarith_stubs_js js_of_ocaml js_of_ocaml-ppx

      - name: Build OCaml
        id: build
        working-directory: isabella.ml
        run: |
          eval $(opam env)
          dune build
          echo "cli-available=true" >> $GITHUB_OUTPUT

      - name: Run CLI examples
        working-directory: isabella.ml
        run: |
          eval $(opam env)
          dune exec isabella_cli -- examples

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v6
        with:
          name: ocaml-cli
          path: isabella.ml/_build/
          retention-days: 1

  # Build TypeScript library (via js_of_ocaml)
  typescript:
    name: TypeScript Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.2'

      - name: Cache opam
        uses: actions/cache@v5
        with:
          path: |
            ~/.opam
            isabella.ml/_build
          key: opam-js-${{ runner.os }}-ocaml5.2-${{ hashFiles('isabella.ml/dune-project') }}
          restore-keys: |
            opam-js-${{ runner.os }}-ocaml5.2-

      - name: Install OCaml dependencies
        run: |
          opam install -y dune zarith zarith_stubs_js js_of_ocaml js_of_ocaml-ppx

      - name: Build JavaScript
        working-directory: isabella.ml
        run: |
          eval $(opam env)
          dune build src/js/isabella_js.bc.js

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Copy JS and build TypeScript
        run: |
          mkdir -p isabella.ts/src
          cp isabella.ml/_build/default/src/js/isabella_js.bc.js isabella.ts/src/isabella.js
          cd isabella.ts
          npm install
          npm run build

      - name: Run TypeScript examples
        working-directory: isabella.ts
        run: |
          node examples/example.mjs || echo "Examples complete"

  # Cross-validation tests against noble-post-quantum
  test-validation:
    name: Cross-Validation Tests
    runs-on: ubuntu-latest
    needs: ocaml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.2'

      - name: Install OCaml dependencies
        run: |
          opam install -y dune zarith zarith_stubs_js js_of_ocaml js_of_ocaml-ppx

      - name: Build OCaml CLI
        working-directory: isabella.ml
        run: |
          eval $(opam env)
          dune build

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: tests/package-lock.json

      - name: Install test dependencies
        working-directory: tests
        run: npm ci

      - name: Run cross-validation tests
        working-directory: tests
        run: |
          eval $(opam env)
          npm test
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: tests/coverage/
          retention-days: 7

  # Summary job
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [changes, isabelle, haskell, ocaml, typescript, test-validation]
    if: always()
    steps:
      - name: Check status
        run: |
          # Isabelle is allowed to be skipped if no Canon changes
          if [[ "${{ needs.isabelle.result }}" == "failure" ]]; then
            echo "Isabelle build failed"
            exit 1
          fi
          if [[ "${{ needs.haskell.result }}" == "failure" ]]; then
            echo "Haskell build failed"
            exit 1
          fi
          if [[ "${{ needs.ocaml.result }}" == "failure" ]]; then
            echo "OCaml build failed"
            exit 1
          fi
          if [[ "${{ needs.typescript.result }}" == "failure" ]]; then
            echo "TypeScript build failed"
            exit 1
          fi
          if [[ "${{ needs.test-validation.result }}" == "failure" ]]; then
            echo "Cross-validation tests failed"
            exit 1
          fi
          echo "All checks passed!"
          if [[ "${{ needs.isabelle.result }}" == "skipped" ]]; then
            echo "(Isabelle build skipped - no Canon changes detected)"
          fi
