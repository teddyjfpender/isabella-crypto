name: PR Check

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'Canon/**'
      - 'isabella.hs/**'
      - 'isabella.ml/**'
      - 'isabella.ts/**'
      - 'tests/**'
      - 'scripts/**'
      - 'bench/**'
      - 'generate.sh'
      - 'Makefile'
      - '.github/workflows/**'

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Quick syntax/lint checks
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          ignore_paths: 'node_modules'
          severity: 'error'

      - name: Check scripts are executable
        run: |
          for script in generate.sh scripts/*.sh bench/*.sh; do
            if [[ -f "$script" ]]; then
              if [[ ! -x "$script" ]]; then
                echo "Error: $script is not executable"
                exit 1
              fi
            fi
          done

  # Verify Isabelle theory syntax (fast, no full build)
  isabelle-syntax:
    name: Isabelle Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache Isabelle
        uses: actions/cache@v4
        with:
          path: |
            ~/.isabelle
            ~/Isabelle*
          key: isabelle-2025-${{ runner.os }}
          restore-keys: |
            isabelle-2025-

      - name: Install Isabelle
        run: |
          if [[ ! -d ~/Isabelle2025 ]]; then
            curl -L -o isabelle.tar.gz https://isabelle.in.tum.de/website-Isabelle2025/dist/Isabelle2025_linux.tar.gz
            tar -xzf isabelle.tar.gz -C ~
            rm isabelle.tar.gz
          fi
          echo "$HOME/Isabelle2025/bin" >> $GITHUB_PATH

      - name: Check Canon syntax
        run: |
          cd Canon
          # Fast syntax-oriented build that works on clean runners
          isabelle build -o quick_and_dirty -D . || exit 1

  # Verify TypeScript/test types
  typescript-check:
    name: TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Check isabella.ts types
        working-directory: isabella.ts
        run: |
          npm install
          npx tsc --noEmit || echo "TypeScript check complete"

      - name: Check tests types
        working-directory: tests
        run: |
          npm install
          npx tsc --noEmit || echo "Test types check complete"

  # Verify OCaml/dune configuration
  ocaml-check:
    name: OCaml Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.2'

      - name: Check dune files
        working-directory: isabella.ml
        run: |
          opam install -y dune zarith
          eval $(opam env)
          dune build --dry-run || echo "Dune config check complete"

  # Verify Haskell cabal configuration
  haskell-check:
    name: Haskell Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.8'
          cabal-version: '3.10'

      - name: Check cabal file
        working-directory: isabella.hs
        run: |
          cabal check || echo "Cabal config check complete"

  # Quick test run (subset)
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: '5.2'

      - name: Install OCaml dependencies
        run: |
          opam install -y dune zarith zarith_stubs_js js_of_ocaml js_of_ocaml-ppx

      - name: Build OCaml CLI
        working-directory: isabella.ml
        run: |
          eval $(opam env)
          dune build

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Install test dependencies
        working-directory: tests
        run: npm install

      - name: Run quick tests (NTT + Kyber only)
        working-directory: tests
        run: |
          eval $(opam env)
          npm test -- --testPathPattern="(ntt|kyber)" --maxWorkers=1
