# Isabella - Verified Lattice Cryptography

Formally verified lattice-based cryptographic primitives extracted from Isabelle/HOL proofs.

## What is this?

This library contains Haskell implementations of lattice cryptography that have been:

1. **Specified** in Isabelle/HOL with precise mathematical definitions
2. **Proven correct** with machine-checked proofs (no `sorry`!)
3. **Extracted** to executable Haskell code via Isabelle's code generation

The result is cryptographic code you can trust - the proofs guarantee correctness properties hold.

## Modules

| Module | Description |
|--------|-------------|
| `Lattice.LWE` | Basic LWE encryption scheme |
| `Lattice.LWE_Regev` | Regev's LWE public-key encryption |

## Usage

```haskell
import Lattice.LWE_Regev

-- Create keys (in practice, use secure random generation)
let pk = Lwe_public_key_ext matrixA vectorB ()
let sk = Lwe_secret_key_ext secretS ()

-- Encrypt a bit
let ciphertext = lwe_encrypt pk q randomR True

-- Decrypt
let plaintext = lwe_decrypt sk q ciphertext
-- plaintext == True (when noise is bounded)
```

## Verified Properties

The Isabelle proofs establish:

- **Correctness**: `|noise| < q/4 ==> decrypt(encrypt(m)) = m`
- **Encode/Decode inverse**: `decode(encode(b)) = b` for valid parameters
- **Algebraic properties**: Vector operations satisfy expected laws

## Building

```bash
cd haskell/isabella
cabal build
```

## A Note on Generated Code Style

The Haskell code in this library is **generated by Isabelle's code extraction**, not hand-written. This means it has a different style than typical Haskell and produces various GHC warnings. This is normal and does not indicate problems with correctness.

**Common warnings you'll see:**

| Warning | Why It's OK |
|---------|-------------|
| Unused imports | Isabelle conservatively imports everything it might need |
| Unused constructors (`One`, `Bit0`, `Bit1`) | Infrastructure for numeral representation |
| Incomplete patterns (`nth []`, `hd []`) | The proofs guarantee these are only called on non-empty lists |
| Name shadowing | Record field names shadow function names (Isabelle convention) |
| Unused matches | Generated code doesn't optimize for this |

**Why this is safe:**

1. **Proofs guarantee safe usage** - Partial functions like `hd` are only called when the Isabelle proofs establish the list is non-empty
2. **Extraction is proven correct** - Isabelle's code generator is verified to preserve semantics
3. **No `sorry` or `oops`** - All proofs in the source theories are complete

The trade-off is: we get machine-verified correctness at the cost of GHC linter noise. The code is correct by construction from the proofs, even if it doesn't satisfy stylistic preferences.

## Regenerating

To regenerate the Haskell code from Isabelle proofs:

```bash
# Run the proof loop for a prompt
ralph/isabella-loop.sh --prompt isabelle-lwe-regev-01 ...

# Collect generated code into this library
./collect.sh                # Haskell only (default)
./collect.sh --lang all     # All languages (Haskell, SML, OCaml, Scala)
```

## License

MIT
